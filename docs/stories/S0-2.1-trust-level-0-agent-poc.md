# Story S0-2.1: Trust Level 0 Agent PoC

## Story Details
**ID**: S0-2.1  
**Epic**: 2 - Core PoCs & Validation  
**Priority**: Critical (P0)  
**Estimated Points**: 13  
**Assigned To**: Full Stack Developer  
**Sprint**: Sprint-0  
**Status**: In Progress  

## User Story
As a system administrator,  
I need a proof of concept for a Trust Level 0 (Observed) agent,  
So that I can validate the agent framework with maximum safety controls where all actions require explicit user approval.

## Technical Context
**Purpose**: Implement and validate L0 trust level agent with full observation mode  
**Scope**: Complete L0 agent implementation with approval workflows, audit logging, and safety mechanisms  
**Integration**: Uses S0-1.2 orchestrator and S0-1.3 UI foundation  

## Acceptance Criteria
1. [ ] L0 agent cannot execute any action without explicit user approval
2. [ ] All agent suggestions are presented with clear rationale
3. [ ] Complete audit trail of all decisions and approvals
4. [ ] Rollback capability for any approved action
5. [ ] Risk assessment display for each suggested action
6. [ ] Approval workflow with timeout handling
7. [ ] Dry-run mode for testing suggestions
8. [ ] Performance metrics collection (decision time, accuracy)
9. [ ] Error handling with graceful degradation
10. [ ] Integration with trust progression system

## Tasks / Subtasks

### Phase 1: L0 Agent Implementation (4 hours)
- [ ] Create `/services/agents/personas/l0_agent.py` (AC: 1, 2)
  - [ ] Implement BaseL0Agent class
  - [ ] Add observation-only mode logic
  - [ ] Create suggestion generation system
  - [ ] Implement approval request mechanism
- [ ] Create `/services/agents/approval/workflow.py` (AC: 1, 6)
  - [ ] Design approval workflow engine
  - [ ] Add timeout handling (default 5 min)
  - [ ] Create approval state machine
  - [ ] Implement approval persistence

### Phase 2: Risk Assessment System (3 hours)
- [ ] Create `/services/agents/risk/assessor.py` (AC: 5)
  - [ ] Implement RiskAssessor class
  - [ ] Define risk scoring algorithm
  - [ ] Create risk categorization (low/medium/high/critical)
  - [ ] Add risk mitigation suggestions
- [ ] Create `/services/agents/risk/policies.py` (AC: 5, 7)
  - [ ] Define risk policy rules
  - [ ] Implement policy evaluation engine
  - [ ] Add dry-run execution mode
  - [ ] Create policy override mechanism

### Phase 3: Audit & Rollback System (3 hours)
- [ ] Create `/services/agents/audit/l0_auditor.py` (AC: 3, 4)
  - [ ] Implement comprehensive audit logging
  - [ ] Add decision rationale capture
  - [ ] Create approval tracking
  - [ ] Add user feedback recording
- [ ] Create `/services/agents/rollback/manager.py` (AC: 4)
  - [ ] Design rollback mechanism
  - [ ] Implement action reversal logic
  - [ ] Add rollback validation
  - [ ] Create rollback history tracking

### Phase 4: UI Components for L0 (2 hours)
- [ ] Create `/frontend/components/l0/ApprovalDialog.tsx` (AC: 1, 2, 5)
  - [ ] Design approval dialog component
  - [ ] Add rationale display section
  - [ ] Create risk indicator UI
  - [ ] Implement timer display
- [ ] Create `/frontend/components/l0/SuggestionCard.tsx` (AC: 2, 5)
  - [ ] Implement suggestion display card
  - [ ] Add code diff viewer
  - [ ] Create impact analysis view
  - [ ] Add approve/reject controls
- [ ] Create `/frontend/components/l0/AuditTrail.tsx` (AC: 3)
  - [ ] Design audit trail viewer
  - [ ] Add filtering capabilities
  - [ ] Create export functionality
  - [ ] Implement search feature

### Phase 5: Integration & Testing (1 hour)
- [ ] Create `/tests/integration/test_l0_agent.py` (AC: all)
  - [ ] Test approval workflow
  - [ ] Test timeout scenarios
  - [ ] Test rollback functionality
  - [ ] Test risk assessment
- [ ] Create `/tests/e2e/test_l0_workflow.spec.ts` (AC: all)
  - [ ] Test complete L0 workflow
  - [ ] Test approval UI interactions
  - [ ] Test audit trail generation
  - [ ] Test error scenarios

## Dev Notes

### L0 Agent Behavior Model
```python
class L0AgentBehavior:
    """
    Trust Level 0: Observed Mode
    - Cannot execute without approval
    - Must provide detailed rationale
    - All actions are logged
    - Rollback always available
    """
    
    CAPABILITIES = {
        "execute": False,
        "suggest": True,
        "observe": True,
        "learn": True
    }
    
    APPROVAL_REQUIRED = [
        "code_generation",
        "code_modification",
        "file_operations",
        "system_commands",
        "api_calls",
        "database_queries"
    ]
    
    RISK_THRESHOLDS = {
        "low": 0.3,
        "medium": 0.6,
        "high": 0.8,
        "critical": 0.95
    }
```

### Approval Workflow States
```typescript
enum ApprovalState {
  PENDING = "pending",
  APPROVED = "approved",
  REJECTED = "rejected",
  TIMEOUT = "timeout",
  CANCELLED = "cancelled"
}

interface ApprovalRequest {
  id: string;
  agentId: string;
  sessionId: string;
  action: {
    type: string;
    description: string;
    code?: string;
    impact: string[];
  };
  rationale: string;
  riskLevel: "low" | "medium" | "high" | "critical";
  riskScore: number;
  requestedAt: Date;
  expiresAt: Date;
  state: ApprovalState;
  approvedBy?: string;
  approvalNote?: string;
}
```

### Risk Assessment Matrix
| Action Type | Base Risk | Factors | Mitigation |
|------------|-----------|---------|------------|
| Read Operation | 0.1 | Data sensitivity | Access control |
| Write Operation | 0.5 | Scope, reversibility | Backup, validation |
| Delete Operation | 0.8 | Data criticality | Confirmation, soft delete |
| System Command | 0.9 | Command type | Sandboxing, whitelist |
| External API | 0.7 | Endpoint trust | Rate limiting, validation |

### Audit Log Schema
```json
{
  "timestamp": "2025-01-11T10:30:00Z",
  "agent_id": "uuid",
  "session_id": "uuid",
  "user_id": "uuid",
  "action": {
    "type": "code_generation",
    "description": "Generate unit test",
    "approved": true,
    "risk_level": "low",
    "risk_score": 0.25
  },
  "rationale": "User requested unit test for add function",
  "result": {
    "status": "success",
    "output": "def test_add()...",
    "execution_time_ms": 150
  },
  "rollback_available": true,
  "rollback_id": "uuid"
}
```

### Performance Metrics
- Suggestion generation: <500ms
- Risk assessment: <100ms
- Approval UI render: <50ms
- Audit log write: <10ms
- Rollback execution: <1s

### Safety Mechanisms
1. **Double Confirmation**: Critical actions require two-step approval
2. **Timeout Protection**: Auto-reject after 5 minutes
3. **Rate Limiting**: Max 10 pending approvals per session
4. **Sandboxing**: Dry-run execution in isolated environment
5. **Audit Immutability**: Audit logs cannot be modified or deleted

## Testing Scenarios
1. **Happy Path**: User approves low-risk suggestion
2. **Rejection Flow**: User rejects high-risk action
3. **Timeout Handling**: Approval request expires
4. **Rollback Execution**: Approved action is rolled back
5. **Risk Escalation**: Action risk increases based on context
6. **Bulk Approval**: Multiple related actions approved together
7. **Emergency Stop**: All pending approvals cancelled
8. **Audit Export**: Full audit trail exported for compliance

## Dependencies
- S0-1.1: Database schema for audit logs
- S0-1.2: Orchestrator for agent management
- S0-1.3: UI components for approval interface
- Python 3.11+ for backend
- React 18+ for frontend
- PostgreSQL for audit storage

## Risk Mitigation
- **Over-approval Risk**: Implement approval fatigue detection
- **Timeout Risk**: Configurable timeout with notifications
- **Rollback Risk**: Validate rollback safety before execution
- **Audit Risk**: Redundant audit storage with checksums

## Definition of Done
- [ ] All 10 acceptance criteria met
- [ ] Unit test coverage > 85%
- [ ] Integration tests passing
- [ ] E2E approval workflow tested
- [ ] Risk assessment validated
- [ ] Rollback tested for all action types
- [ ] Audit trail verified immutable
- [ ] Performance benchmarks met
- [ ] Security review completed
- [ ] Documentation updated

## Commands
```bash
# Run L0 agent tests
pytest tests/integration/test_l0_agent.py -v

# Test approval workflow
pytest tests/unit/services/agents/approval/ -v

# Run E2E tests
npm run test:e2e -- test_l0_workflow.spec.ts

# Validate risk policies
python scripts/validate_risk_policies.py

# Export audit logs
python scripts/export_audit_logs.py --session-id <id>
```

---
**Created**: January 11, 2025  
**Last Updated**: January 11, 2025  
**Story Points**: 13  
**Status**: Ready for Development