# Story S0-2.5: Create Configuration System for YOLO Token Limits

## Story
**As a** system administrator  
**I want** configurable token limits and system parameters  
**So that** I can tune the YOLO system for different environments and workloads without code changes

## Status
- **State**: READY
- **Priority**: P2 (Medium - Flexibility)
- **Points**: 3
- **Sprint**: Next

## Acceptance Criteria
- [ ] External configuration file for all tunable parameters
- [ ] Environment variable override support
- [ ] Runtime configuration reload without restart
- [ ] Validation of configuration values
- [ ] Default fallback for missing configuration
- [ ] Configuration documentation and schema

## Technical Details

### Configuration Structure

1. **YAML Configuration File**
```yaml
# /home/omar/Documents/ruleIQ/.bmad-core/yolo/config/yolo-config.yaml

# System Configuration
system:
  mode: active  # active, paused, off
  log_level: INFO
  state_file: .bmad-core/yolo/state/yolo-state.json
  enable_telemetry: true
  
# Agent Token Limits (in tokens)
agent_limits:
  pm: 6000
  architect: 8000
  po: 5000
  sm: 4000
  dev: 10000
  qa: 6000
  security: 5000
  devops: 5000
  documentation: 4000

# Context Management
context:
  summarization_threshold: 0.7
  refresh_strategy: sliding_window  # sliding_window, priority_based, lru
  archive_old_context: true
  archive_after_days: 7
  max_total_tokens: 50000
  
# Retry Configuration
retry:
  max_attempts: 3
  backoff_factor: 2.0
  max_backoff_seconds: 60
  circuit_breaker_threshold: 5
  circuit_breaker_timeout: 300

# Safety Configuration
safety:
  require_human_for:
    - password_hashing
    - database_migrations
    - deployment_prod
    - security_patches
    - user_data_deletion
  auto_approve_after_seconds: 3600
  
# Workflow Configuration
workflow:
  default_timeout_seconds: 300
  handoff_timeout_seconds: 30
  max_concurrent_agents: 3
  enable_parallel_workflows: false
  
# Monitoring
monitoring:
  metrics_port: 9090
  health_check_port: 8080
  export_interval_seconds: 60
  retention_days: 30
```

2. **Configuration Loader Class**
```python
# /home/omar/Documents/ruleIQ/.bmad-core/yolo/config_manager.py

import os
import yaml
from typing import Dict, Any, Optional
from pathlib import Path
from dataclasses import dataclass
import jsonschema
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

@dataclass
class YOLOConfig:
    """YOLO system configuration."""
    system: Dict[str, Any]
    agent_limits: Dict[str, int]
    context: Dict[str, Any]
    retry: Dict[str, Any]
    safety: Dict[str, Any]
    workflow: Dict[str, Any]
    monitoring: Dict[str, Any]
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'YOLOConfig':
        """Create config from dictionary."""
        return cls(**data)
    
    def get_agent_limit(self, agent: str) -> int:
        """Get token limit for agent."""
        return self.agent_limits.get(agent, 5000)

class ConfigManager:
    """Manages YOLO configuration with hot reload."""
    
    CONFIG_SCHEMA = {
        "type": "object",
        "properties": {
            "system": {"type": "object"},
            "agent_limits": {
                "type": "object",
                "patternProperties": {
                    "^[a-z_]+$": {"type": "integer", "minimum": 1000, "maximum": 50000}
                }
            },
            "context": {"type": "object"},
            "retry": {
                "type": "object",
                "properties": {
                    "max_attempts": {"type": "integer", "minimum": 1, "maximum": 10},
                    "backoff_factor": {"type": "number", "minimum": 1.0, "maximum": 10.0}
                }
            }
        },
        "required": ["system", "agent_limits"]
    }
    
    def __init__(self, config_path: str = None):
        """Initialize configuration manager."""
        self.config_path = Path(config_path or ".bmad-core/yolo/config/yolo-config.yaml")
        self.config: Optional[YOLOConfig] = None
        self._load_config()
        self._setup_watcher()
        
    def _load_config(self):
        """Load configuration from file with environment overrides."""
        # Load base config from file
        if self.config_path.exists():
            with open(self.config_path) as f:
                data = yaml.safe_load(f)
        else:
            data = self._get_default_config()
        
        # Apply environment variable overrides
        data = self._apply_env_overrides(data)
        
        # Validate configuration
        jsonschema.validate(data, self.CONFIG_SCHEMA)
        
        # Create config object
        self.config = YOLOConfig.from_dict(data)
        
    def _apply_env_overrides(self, config: Dict[str, Any]) -> Dict[str, Any]:
        """Apply environment variable overrides."""
        # Example: YOLO_AGENT_LIMITS_DEV=15000
        for key, value in os.environ.items():
            if key.startswith('YOLO_'):
                parts = key[5:].lower().split('_')
                self._set_nested(config, parts, value)
        return config
    
    def _set_nested(self, d: Dict, keys: List[str], value: str):
        """Set nested dictionary value."""
        for key in keys[:-1]:
            d = d.setdefault(key, {})
        # Convert value to appropriate type
        try:
            d[keys[-1]] = int(value)
        except ValueError:
            try:
                d[keys[-1]] = float(value)
            except ValueError:
                d[keys[-1]] = value.lower() == 'true' if value.lower() in ['true', 'false'] else value
    
    def _get_default_config(self) -> Dict[str, Any]:
        """Get default configuration."""
        return {
            "system": {
                "mode": "active",
                "log_level": "INFO"
            },
            "agent_limits": {
                "pm": 6000,
                "architect": 8000,
                "po": 5000,
                "sm": 4000,
                "dev": 10000,
                "qa": 6000
            },
            "context": {
                "summarization_threshold": 0.7,
                "refresh_strategy": "sliding_window"
            },
            "retry": {
                "max_attempts": 3,
                "backoff_factor": 2.0
            },
            "safety": {
                "require_human_for": ["password_hashing", "database_migrations"]
            },
            "workflow": {
                "default_timeout_seconds": 300
            },
            "monitoring": {
                "metrics_port": 9090
            }
        }
    
    def _setup_watcher(self):
        """Setup file watcher for hot reload."""
        class ConfigReloadHandler(FileSystemEventHandler):
            def __init__(self, config_manager):
                self.config_manager = config_manager
                
            def on_modified(self, event):
                if event.src_path == str(self.config_manager.config_path):
                    print(f"Config file changed, reloading...")
                    self.config_manager._load_config()
        
        self.observer = Observer()
        self.observer.schedule(
            ConfigReloadHandler(self),
            str(self.config_path.parent),
            recursive=False
        )
        self.observer.start()
    
    def get(self, key_path: str, default: Any = None) -> Any:
        """Get configuration value by dot-notation path."""
        keys = key_path.split('.')
        value = self.config.__dict__
        for key in keys:
            if isinstance(value, dict):
                value = value.get(key)
            else:
                value = getattr(value, key, None)
            if value is None:
                return default
        return value
```

3. **Integration with YOLO System**
```python
# Update yolo-system.py

class YOLOOrchestrator:
    def __init__(self, config_path: str = None):
        """Initialize with configuration."""
        self.config_manager = ConfigManager(config_path)
        self.config = self.config_manager.config
        
        # Use configured values
        if ContextRefreshSystem:
            # Override default limits with config
            ContextRefreshSystem.AGENT_CONTEXT_LIMITS = self.config.agent_limits
            self.context_manager = ContextRefreshSystem()
```

## Dependencies
- pyyaml for YAML parsing
- jsonschema for validation
- watchdog for file monitoring

## Testing
- Test configuration loading from file
- Test environment variable overrides
- Test hot reload functionality
- Test validation of invalid configs
- Test default fallback behavior
- Performance test of config access

## Definition of Done
- [ ] Configuration schema defined
- [ ] Config loader implemented
- [ ] Environment override working
- [ ] Hot reload functional
- [ ] Validation in place
- [ ] Documentation complete
- [ ] Example config file provided
- [ ] Migration guide for hardcoded values