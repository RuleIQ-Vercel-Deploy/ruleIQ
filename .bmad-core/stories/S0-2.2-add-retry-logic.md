# Story S0-2.2: Add Retry Logic for Agent Handoffs

## Story
**As a** YOLO system operator  
**I want** automatic retry logic for failed agent handoffs  
**So that** the system can recover from transient failures without manual intervention

## Status
- **State**: READY
- **Priority**: P1 (High - Reliability)
- **Points**: 3
- **Sprint**: Current

## Acceptance Criteria
- [ ] Implement exponential backoff retry mechanism
- [ ] Configure max retry attempts (default: 3)
- [ ] Log each retry attempt with appropriate detail
- [ ] Preserve context during retries
- [ ] Fail gracefully after max retries with clear error message
- [ ] Add retry metrics for monitoring

## Technical Details

### Implementation Approach
1. Create retry decorator with exponential backoff
2. Apply to handoff() method in YOLOOrchestrator
3. Add configuration for retry parameters
4. Implement circuit breaker pattern for repeated failures

### Code Structure
```python
import asyncio
from functools import wraps
from typing import TypeVar, Callable

def async_retry(max_attempts: int = 3, backoff_factor: float = 2.0):
    """Decorator for async functions with exponential backoff retry."""
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        async def wrapper(*args, **kwargs):
            last_exception = None
            for attempt in range(max_attempts):
                try:
                    return await func(*args, **kwargs)
                except Exception as e:
                    last_exception = e
                    if attempt < max_attempts - 1:
                        wait_time = backoff_factor ** attempt
                        logger.warning(f"Attempt {attempt + 1} failed: {e}. Retrying in {wait_time}s...")
                        await asyncio.sleep(wait_time)
                    else:
                        logger.error(f"All {max_attempts} attempts failed")
            raise last_exception
        return wrapper
    return decorator

# Apply to handoff method
@async_retry(max_attempts=3, backoff_factor=2.0)
async def handoff(self, to_agent: AgentType, ...):
    # Existing handoff logic
```

### Files to Update
1. `/home/omar/Documents/ruleIQ/.bmad-core/yolo/yolo-system.py`
   - Add retry decorator
   - Apply to handoff() method
   - Add retry configuration

2. Create `/home/omar/Documents/ruleIQ/.bmad-core/yolo/retry_utils.py`
   - Implement retry decorator
   - Add circuit breaker logic
   - Include retry metrics

## Dependencies
- Story S0-2.1 (datetime fixes) should be completed first

## Testing
- Test successful handoff (no retry needed)
- Test single retry success
- Test max retries exhausted
- Test context preservation during retries
- Test exponential backoff timing
- Test circuit breaker activation

## Definition of Done
- [ ] Retry logic implemented
- [ ] Tests cover all retry scenarios
- [ ] Metrics/logging in place
- [ ] Documentation updated
- [ ] Code reviewed
- [ ] Performance impact assessed