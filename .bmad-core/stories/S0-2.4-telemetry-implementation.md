# Story S0-2.4: Implement Telemetry and Monitoring for YOLO System

## Story
**As a** DevOps engineer  
**I want** comprehensive telemetry and monitoring for the YOLO system  
**So that** we can track performance, detect issues early, and optimize agent operations

## Status
- **State**: READY
- **Priority**: P2 (Medium - Observability)
- **Points**: 5
- **Sprint**: Next

## Acceptance Criteria
- [ ] Implement metrics collection for key operations
- [ ] Add distributed tracing for agent workflows
- [ ] Create health check endpoints
- [ ] Set up alerting thresholds
- [ ] Provide dashboard-ready metrics export
- [ ] Include performance profiling capabilities

## Technical Details

### Metrics to Track

1. **Agent Metrics**
```python
class AgentMetrics:
    """Metrics for agent operations."""
    
    # Counters
    handoffs_total: int
    decisions_made: int
    errors_total: int
    safety_blocks: int
    
    # Gauges
    current_agents_active: int
    context_items_total: int
    context_tokens_used: int
    
    # Histograms
    handoff_duration_seconds: List[float]
    decision_time_seconds: List[float]
    context_refresh_time_seconds: List[float]
    
    # Per-agent breakdown
    agent_active_time: Dict[str, float]
    agent_error_rate: Dict[str, float]
```

2. **System Metrics**
```python
class SystemMetrics:
    """System-wide metrics."""
    
    # Resource usage
    memory_usage_mb: float
    cpu_usage_percent: float
    
    # Workflow metrics
    workflows_completed: int
    workflows_failed: int
    average_workflow_time: float
    
    # State persistence
    state_saves_total: int
    state_load_time_ms: float
    state_file_size_bytes: int
```

### Implementation Structure

1. **Create Telemetry Module**
```python
# /home/omar/Documents/ruleIQ/.bmad-core/yolo/telemetry.py

import time
import psutil
from dataclasses import dataclass, field
from typing import Dict, List, Optional
from prometheus_client import Counter, Gauge, Histogram, Info
import logging

class YOLOTelemetry:
    """Telemetry system for YOLO operations."""
    
    def __init__(self):
        # Prometheus metrics
        self.handoff_counter = Counter('yolo_handoffs_total', 
                                      'Total agent handoffs', 
                                      ['from_agent', 'to_agent'])
        
        self.decision_counter = Counter('yolo_decisions_total',
                                       'Total decisions made',
                                       ['agent', 'decision_type'])
        
        self.handoff_duration = Histogram('yolo_handoff_duration_seconds',
                                         'Handoff duration in seconds',
                                         ['from_agent', 'to_agent'])
        
        self.context_tokens = Gauge('yolo_context_tokens',
                                   'Current context token count',
                                   ['agent'])
        
        self.agent_status = Info('yolo_agent_status',
                               'Current agent status')
        
    def record_handoff(self, from_agent: str, to_agent: str, duration: float):
        """Record handoff metrics."""
        self.handoff_counter.labels(from_agent=from_agent, to_agent=to_agent).inc()
        self.handoff_duration.labels(from_agent=from_agent, to_agent=to_agent).observe(duration)
    
    def record_decision(self, agent: str, decision_type: str):
        """Record decision metrics."""
        self.decision_counter.labels(agent=agent, decision_type=decision_type).inc()
    
    def update_context_tokens(self, agent: str, tokens: int):
        """Update context token gauge."""
        self.context_tokens.labels(agent=agent).set(tokens)
```

2. **Health Check Endpoint**
```python
# Add to yolo-system.py

async def get_health_status(self) -> Dict[str, Any]:
    """Get system health status."""
    return {
        "status": "healthy" if self.state.mode == YOLOMode.ACTIVE else "degraded",
        "mode": self.state.mode.value,
        "current_agent": self.state.current_agent.value if self.state.current_agent else None,
        "uptime_seconds": (datetime.now(UTC) - self.state.started_at).total_seconds(),
        "errors_last_hour": self.get_recent_errors(),
        "memory_usage_mb": psutil.Process().memory_info().rss / 1024 / 1024,
        "context_health": self.context_manager.get_health() if self.context_manager else "N/A"
    }
```

3. **Distributed Tracing**
```python
from opentelemetry import trace
from opentelemetry.trace import Tracer

tracer = trace.get_tracer(__name__)

class TracedOrchestrator(YOLOOrchestrator):
    """Orchestrator with distributed tracing."""
    
    async def handoff(self, to_agent: AgentType, **kwargs):
        """Traced handoff operation."""
        with tracer.start_as_current_span("handoff") as span:
            span.set_attribute("from_agent", self.state.current_agent.value)
            span.set_attribute("to_agent", to_agent.value)
            
            try:
                result = await super().handoff(to_agent, **kwargs)
                span.set_status(trace.Status(trace.StatusCode.OK))
                return result
            except Exception as e:
                span.record_exception(e)
                span.set_status(trace.Status(trace.StatusCode.ERROR))
                raise
```

### Monitoring Dashboard Configuration

```yaml
# /home/omar/Documents/ruleIQ/.bmad-core/yolo/monitoring/dashboard.yaml

dashboards:
  - name: YOLO System Overview
    panels:
      - title: Agent Activity
        type: graph
        query: rate(yolo_handoffs_total[5m])
        
      - title: Decision Rate
        type: graph
        query: rate(yolo_decisions_total[5m])
        
      - title: Context Token Usage
        type: gauge
        query: yolo_context_tokens
        
      - title: Error Rate
        type: graph
        query: rate(yolo_errors_total[5m])
        
      - title: Handoff Duration P95
        type: stat
        query: histogram_quantile(0.95, yolo_handoff_duration_seconds)

alerts:
  - name: HighErrorRate
    expr: rate(yolo_errors_total[5m]) > 0.1
    for: 5m
    annotations:
      summary: "High error rate in YOLO system"
      
  - name: ContextOverflow
    expr: yolo_context_tokens > 9000
    for: 1m
    annotations:
      summary: "Context tokens approaching limit for {{ $labels.agent }}"
```

## Dependencies
- Prometheus client library
- OpenTelemetry SDK (optional)
- psutil for system metrics

## Testing
- Verify all metrics are collected correctly
- Test metric export format
- Validate health check responses
- Test distributed tracing spans
- Performance impact assessment (<2% overhead)

## Definition of Done
- [ ] Telemetry module implemented
- [ ] Health check endpoint working
- [ ] Metrics exported in Prometheus format
- [ ] Dashboard configuration created
- [ ] Alerting rules defined
- [ ] Documentation includes monitoring guide
- [ ] Performance impact validated