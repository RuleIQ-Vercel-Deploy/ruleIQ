
Dservices.neo4j_service.Neo4jGraphRAGService.calculate_residual_risksA
5/home/omar/Documents/ruleIQ/services/neo4j_service.py˙ ˙(&"2*’	
2
˚ ˚(8í
è

˝ ç(
query"__id*Ò

__unknown_file (‘—
Œ
        MATCH (risk:Risk)
        OPTIONAL MATCH (risk)<-[m:MITIGATES]-(ctrl:Control)
        WITH risk, 
             risk.risk_score AS inherent_risk,
             COALESCE(AVG(m.mitigation_percentage), 0) AS avg_mitigation
        RETURN risk.name AS risk_name,
               risk.category AS category,
               inherent_risk,
               ROUND(inherent_risk * (1 - avg_mitigation/100.0), 2) AS residual_risk,
               CASE 
                 WHEN inherent_risk * (1 - avg_mitigation/100.0) >= 15 THEN 'HIGH'
                 WHEN inherent_risk * (1 - avg_mitigation/100.0) >= 10 THEN 'MEDIUM'
                 ELSE 'LOW'
               END AS risk_level
        ORDER BY residual_risk DESC
        òï

è è(1
%1*K

__unknown_file (/-
+services.neo4j_service.Neo4jGraphRAGService*%

__unknown_file (	

query2execute_queryC
A

è è(1	
results"__id*"

__unknown_file (

%1

ê ê(*
%2"dictú
ô

ê ê()
%3"__mapSet*"

__unknown_file (

%2*.

__unknown_file (
residual_risks*'

__unknown_file (
	
results"

ê ê(*

%2B/-
+services.neo4j_service.Neo4jGraphRAGServiceH